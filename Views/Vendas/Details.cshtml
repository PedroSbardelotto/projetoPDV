@model PDV.Models.ViewModels.VendaComprovanteViewModel
@using System.Globalization

@{
    ViewData["Title"] = $"Venda #{Model.Vendas.Id}";
    var culture = new CultureInfo("pt-BR");

    // Status Visual
    string statusBadge = "bg-secondary";
    string statusTexto = "Desconhecido";
    string statusIcon = "bi-question-circle";

    if (Model.Vendas.Status == 1) // Finalizado
    {
        statusBadge = "bg-success bg-opacity-10 text-success border border-success";
        statusTexto = "Aprovado";
        statusIcon = "bi-check-circle-fill";
    }
    else if (Model.Vendas.Status == 2) // Pendente
    {
        statusBadge = "bg-warning bg-opacity-10 text-warning border border-warning";
        statusTexto = "Pendente (Fiado)";
        statusIcon = "bi-clock-history";
    }
    else if (Model.Vendas.Status == 0) 
    {
        statusBadge = "bg-danger bg-opacity-10 text-danger border border-danger";
        statusTexto = "Cancelado";
        statusIcon = "bi-x-circle-fill";
    }
}

<style>
    /* Estilo de Recibo */
    .receipt-card {
        max-width: 480px;
        margin: 0 auto;
        background: #fff;
        position: relative;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Fonte limpa */
    }

    .dashed-divider {
        border-bottom: 2px dashed #e5e7eb;
        margin: 1.5rem 0;
        opacity: 0.6;
    }

    /* Linhas de Informação Gerais */
    .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
        color: #6b7280; /* Cinza médio */
    }
    .info-row span:last-child {
        font-weight: 600;
        color: #111827; /* Preto quase total */
        text-align: right;
    }

    /* Estilização da Lista de Produtos */
    .product-list-header {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 700;
        color: #9ca3af;
        margin-bottom: 1rem;
    }

    .product-item {
        margin-bottom: 0.75rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #f3f4f6; /* Divisor muito sutil entre itens */
    }
    .product-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .product-name {
        font-size: 0.95rem;
        font-weight: 600;
        color: #374151;
        display: block;
        margin-bottom: 2px;
    }

    .product-meta {
        font-size: 0.85rem;
        color: #6b7280;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .product-total {
        font-weight: 700;
        color: #111827;
    }

    /* Estilos de Impressão */
    @@media print {
        body * { visibility: hidden; }
        .receipt-card, .receipt-card * { visibility: visible; }
        .receipt-card {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            max-width: 100%;
            box-shadow: none !important;
            border: none !important;
            margin: 0;
            padding: 0;
        }
        .no-print { display: none !important; }
        .btn { display: none !important; }
    }
</style>

<div class="container py-5">
    
    <div class="d-flex justify-content-between align-items-center mb-4 receipt-card bg-transparent no-print">
        <a asp-action="Index" class="btn btn-outline-secondary rounded-pill px-3 fw-bold btn-sm shadow-sm border-0">
            <i class="bi bi-arrow-left me-1"></i> Voltar
        </a>
        <div class="d-flex gap-2">
            <a asp-action="Comprovante" asp-route-id="@Model?.Vendas.Id" target="_blank" class="btn btn-dark rounded-pill px-3 fw-bold btn-sm shadow-sm">
                <i class="bi bi-printer-fill me-1"></i> Imprimir
            </a>
        </div>
    </div>

    <div class="card receipt-card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-body p-4 p-md-5">
            
            <div class="text-center mb-4">
                <div class="mb-3">
                    <div class="bg-light rounded-circle p-3 d-inline-flex text-dark shadow-sm">
                        <i class="bi bi-receipt fs-2 text-dark"></i>
                    </div>
                </div>
                <h5 class="fw-bold text-uppercase mb-1 letter-spacing-1">Comprovante de Venda</h5>
                <p class="text-muted small mb-0 lh-sm">
                    @if(Model.UsuarioEmpresa != null) 
                    { 
                        <span class="fw-bold text-dark">@Model.UsuarioEmpresa.NomeRazao</span> <br> 
                        <span>CNPJ: @Model.UsuarioEmpresa.CNPJ</span>
                    }
                    else 
                    { 
                        <span class="fw-bold text-dark">PDV System</span> <br>
                        <span>Loja Principal</span> 
                    }
                </p>
                <small class="text-muted d-block mt-2 font-monospace">
                    @Model.Vendas.DataEntrada.ToString("dd/MM/yyyy HH:mm")
                </small>
            </div>

            <div class="text-center my-4 py-3 bg-light bg-opacity-50 rounded-3 border border-light">
                <span class="badge @statusBadge rounded-pill px-3 py-1 mb-2">
                    <i class="bi @statusIcon me-1"></i> @statusTexto
                </span>
                <div class="text-muted small text-uppercase fw-bold mb-0">Valor Total</div>
                <h1 class="display-5 fw-bold text-dark mb-0 ls-tighter">@Model.Vendas.ValorTotal.ToString("C", culture)</h1>
            </div>

            <div class="mb-4">
                <div class="info-row">
                    <span>ID Transação</span>
                    <span class="font-monospace">#@Model.Vendas.Id.ToString("D6")</span>
                </div>
                
                <div class="info-row">
                    <span>Cliente</span>
                    <span class="text-truncate" style="max-width: 200px;">
                        @(Model.Vendas.Cliente != null ? Model.Vendas.Cliente.Nome : "Consumidor Final")
                    </span>
                </div>
                
                @if(Model.Vendas.Cliente != null && !string.IsNullOrEmpty(Model.Vendas.Cliente.CPF))
                {
                    <div class="info-row">
                        <span>CPF/CNPJ</span>
                        <span>@Model.Vendas.Cliente.CPF</span>
                    </div>
                }

                <div class="info-row">
                    <span>Pagamento</span>
                    <span>
                        @if (Model.Vendas.TipoPagamento != null)
                        {
                            <i class="bi bi-credit-card-2-front me-1 text-muted small"></i> @Model.Vendas.TipoPagamento.Descricao
                        }
                        else
                        {
                            <span class="fst-italic text-muted">Não informado</span>
                        }
                    </span>
                </div>
            </div>

            <div class="dashed-divider"></div>

            <div class="mb-2">
                <div class="product-list-header d-flex justify-content-between">
                    <span>Item / Qtd</span>
                    <span>Total Item</span>
                </div>

                @if (Model.Produtos != null && Model.Produtos.Any())
                {
                    @foreach (var item in Model.Produtos)
                    {

                        <div class="product-item">
                            <span class="product-name">
                                @(item.Produto != null ? item.Produto.Nome : "Produto Indefinido")
                            </span>
                            
                            <div class="product-meta">
                                <div>
                                    <span class="fw-bold text-dark">@item.Quantidade.ToString("N0")</span> 
                                    <span class="mx-1 text-muted" style="font-size: 0.75rem;">x</span> 
                                    <span>@item.ValorTotal.ToString("C", culture)</span>
                                </div>
                                <div class="product-total">
                                    @item.Quantidade.ToString("C", culture)
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center py-3 text-muted fst-italic bg-light rounded">
                        <small>Nenhum item listado.</small>
                    </div>
                }
            </div>
            
            <div class="mt-3 pt-2 border-top">
                <div class="d-flex justify-content-between align-items-end">
                    <small class="text-muted fw-bold text-uppercase">Total Itens</small>
                    <small class="fw-bold text-dark">@Model.Produtos?.Count() un.</small>
                </div>
            </div>

            <div class="dashed-divider"></div>

            <div class="mt-4 text-center opacity-75">
                <div style="height: 40px; background: repeating-linear-gradient(90deg, #333 0px, #333 2px, transparent 2px, transparent 4px); max-width: 200px; margin: 0 auto;"></div>
                <p class="small mt-2 mb-0 text-uppercase fw-bold text-muted" style="font-size: 0.65rem; letter-spacing: 2px;">
                    Obrigado pela preferência
                </p>
                <small class="text-muted" style="font-size: 0.6rem;">PDV System v1.0</small>
            </div>

        </div>
    </div>
    
    <div class="text-center mt-3 no-print">
        <small class="text-muted">Este documento não possui valor fiscal.</small>
    </div>
</div>