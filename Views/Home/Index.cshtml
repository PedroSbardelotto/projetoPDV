@model PDV.Models.ViewModels.HomeViewModel
@using System.Globalization

@{
    ViewData["Title"] = "Home Page";
    // Essencial para formatar R$ e para o JavaScript entender os números
    var culture = CultureInfo.InvariantCulture;
}

<div class="container-fluid pt-3">
    <div class="row">

        <div class="col-md-8">

            <div class="mb-3">
                <input type="text" id="product-search" class="form-control form-control-lg" placeholder="Digite o nome ou código do produto...">
            </div>

            <ul class="nav nav-pills mb-3" id="category-filter">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-bs-target-category="all">Todos</a>
                </li>

                @foreach (var categoria in Model.Categorias)
                {
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-target-category="@categoria.Id">@categoria.Nome</a>
                    </li>
                }
            </ul>

            <div class="row" id="product-grid" style="max-height: 70vh; overflow-y: auto;">

                @foreach (var produto in Model.Produtos)
                {
                    <div class="col-md-4 col-lg-3 mb-3 product-card" data-category-id="@produto.CategoriaId">

                        <div class="card h-100 shadow-sm product-clickable"
                             style="cursor: pointer;"
                             data-product-id="@produto.Id"
                             data-product-name="@produto.Nome"
                             data-product-price="@produto.Preco.ToString(culture)">

                            <div class="card-body text-center d-flex flex-column justify-content-center">
                                <h5 class="card-title fs-6">@produto.Nome</h5>
                                <h6 class="card-subtitle mb-2 text-danger fw-bold">@produto.Preco.ToString("C")</h6>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm" style="position: sticky; top: 20px;">
                <div class="card-header text-center">
                    <h4 class="mb-0">Resumo do Pedido</h4>
                </div>

                <ul class="list-group list-group-flush" id="cart-items" style="max-height: 50vh; overflow-y: auto;">

                    <li class="list-group-item text-center text-muted" id="cart-empty-message">
                        Nenhum item adicionado.
                    </li>
                </ul>

                <div class="card-body border-top">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Subtotal</span>
                        <span id="cart-subtotal">R$ 0,00</span>
                    </div>
                    <hr>
                     <div class="row">
                         <div class="col-md-8">
                            <span class="text-muted">Desconto</span>
                         </div>
                         <div class="col-md-4">
                            <input type="number" id="desconto-pagamento" class="form-control" placeholder="0,00"/>
                         </div>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <h5 class="mb-0">Total</h5>
                        <h5 class="mb-0 text-danger fw-bold" id="cart-total">R$ 0,00</h5>
                    </div>
                </div>
                <div class="card-footer p-3 d-none" id="btn-pendencia">
                    <button class="btn btn-primary btn-sm w-50 fw-bold" id="btn-abrir-modal">
                        Gerar Pendência
                    </button>
                </div>
                <div class="card-footer p-3">
                    <button class="btn btn-success btn-lg w-100 fw-bold" id="btn-finish-sale" onclick="subtotalModal()">
                        <i class="bi bi-check-circle-fill me-2"></i>Finalizar Venda
                    </button>
                    <button class="btn btn-danger mt-4" onclick="window.location.href='/Home/FecharCaixa'">
                        Fechar Caixa
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPagamentoSemProduto" tabindex="-1" aria-labelledby="modalPagamentoSemProdutoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPagamentoLabel">Atenção</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <p class="">O carrinho está vazio, insira um produto para finalizar a compra!</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPagamento" tabindex="-1" aria-labelledby="modalPagamentoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPagamentoLabel">Selecionar Tipo de Pagamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <form id="formPagamento" asp-action="Create" asp-controller="Venda">
                            <div id="formasPagamentoContainer">
                                <div class="row mb-2 forma-pagamento">
                                    <div class="col-md-4">
                                        <label for="TipoPagamento_0">Forma de Pagamento</label>
                                        <select class="form-control" name="TipoPagamentoIds">
                                            @foreach (var tipo in ViewBag.TipoPagamentos)
                                            {
                                                <option value="@tipo.Id">@tipo.Descricao</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label>Valor (R$)</label>
                                        <input type="number" id="pagamento" step="0.01" class="form-control" name="ValorPagamentos" placeholder="0,00">
                                    </div>
                                    <div class="col-md-1 d-flex align-items-end">
                                        <button type="button" class="btn btn-danger btn-remove d-none"><i class="bi bi-trash-fill"></i></button>
                                    </div>
                                </div>
                            </div>

                            <button type="button" class="btn btn-outline-primary mt-2" id="btnAddForma">
                                Adicinar
                            </button>
                        </form>
                    </div>
                    <div class="col-md-4 border">
                        <div class="row mt-2">
                            <p class="col-md-6 text-secondary">Subtotal: </p>
                            <p id="total-value-cart" class="col-md-6"></p>
                        </div>
                        <hr>
                        <div class="row">
                            <p class="col-md-6 fs-6">Total a pagar:</p>
                            <p id="total-pagar" class="col-md-6 text-danger fw-bold fs-5"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="formPagamento" class="btn btn-success">Confirmar Pagamento</button>
            </div>
        </div>
    </div>
</div>

@* MODAL PENDENCIA *@
<div class="modal fade" id="modalPendencia" tabindex="-1" aria-labelledby="modalPendenciaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPagamentoLabel">Atenção</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="formPendencia" asp-action="Create" asp-controller="Vendas">
                    <input type="hidden" id="clienteSelecionado" name="ClienteId" />
                    <input type="hidden" id="clienteSelecionado" name="ClienteId" />
                    <input type="hidden" name="ValorTotal" id="valorTotal" />
                    <input type="hidden" name="Status" id="statusVenda" />
                    <input type="hidden" name="DataEntrada" id="dataEntrada" />
                    <input type="hidden" name="DataAtualizacao" id="dataAtualizacao" />
                    <input type="hidden" name="TipoPagamentoId" id="tipoPagamento" />
                    <input type="hidden" name="UsuarioEmpresaId" id="usuarioEmpresa" />
                    <input type="hidden" name="FechamentoId" id="fechamentoId" />

                    <div id="formasPagamentoContainer">
                        <div class="row mb-2 forma-pagamento">
                            <div class="col-md-12">
                                <div class="">
                                    <div class="input-group mb-3">
                                        <input type="text" id="pesquisaCliente" class="form-control" placeholder="Digite nome ou número do cliente...">
                                        <button id="btnPesquisar" class="btn btn-primary" type="button"><i class="bi bi-search"></i></button>
                                    </div>

                                    <table id="cliente-search" class="table table-striped d-none">
                                        <thead>
                                            <tr>
                                                <th>Número</th>
                                                <th>Nome</th>
                                            </tr>
                                        </thead>
                                        <tbody id="listaClientes">
                                            @foreach (var cliente in Model.Clientes)
                                            {
                                                <tr>
                                                    <td>@cliente.Id</td>
                                                    <td>@cliente.Nome</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                    <p id="clienteSelecionadoNome" class="mt-2 fw-bold text-primary"></p>
                                </div>
                            </div>
                          </div> 
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="formPendencia" class="btn btn-success">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Faz a linha parecer clicável */
    #listaClientes tr {
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
    }

        /* Quando a linha é selecionada */
        #listaClientes tr.table-active {
            background-color: #0d6efd !important; /* azul padrão Bootstrap */
            color: #fff !important;
            font-weight: 600;
        }
</style>

@section Scripts {
    <script>
        // Função para formatar moeda (para exibir no carrinho)
        const formatCurrency = (value) => {
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };

        // Estado do carrinho (um array de objetos)
        let cart = [];

        document.getElementById('btn-abrir-modal').addEventListener('click', () => {
                const bntPendencia = document.getElementById('modalPendencia')
                const modalPendencia = new bootstrap.Modal(bntPendencia);
                modalPendencia.show()
                return
            })

        document.getElementById("btnPesquisar").addEventListener("click", function () {
            const termo = document.getElementById("pesquisaCliente").value.toLowerCase().trim();
            const showClient = document.getElementById("cliente-search");
            const linhas = document.querySelectorAll("#listaClientes tr");
            const msgNenhum = document.getElementById("msg-nenhum");

            // Se o campo estiver vazio, não faz a busca
            if (!termo) {
                return;
            }

            showClient.classList.remove("d-none");

            let encontrou = false;

            linhas.forEach(linha => {
                const numero = linha.children[0].textContent.toLowerCase();
                const nome = linha.children[1].textContent.toLowerCase();

                if (numero.includes(termo) || nome.includes(termo)) {
                    linha.style.display = "";
                    encontrou = true;
                } else {
                    linha.style.display = "none";
                }
            });

            // Exibe ou oculta a linha de "nenhum resultado"
            if (msgNenhum) {
                msgNenhum.style.display = encontrou ? "none" : "";
            }
        });

        const listaClientes = document.getElementById("listaClientes");

        if (listaClientes) {
          listaClientes.addEventListener("click", function (e) {
            const linha = e.target.closest("tr");
            if (!linha) return;
            if (linha.style.display === "none") return;

            const inputHidden = document.getElementById("clienteSelecionado");
            const nomeVisual = document.getElementById("clienteSelecionadoNome");

            const clienteId = linha.children[0].textContent.trim();
            const clienteNome = linha.children[1].textContent.trim();

            // Se já está selecionado, desseleciona
            if (linha.classList.contains("table-active")) {
              linha.classList.remove("table-active");
              if (inputHidden) inputHidden.value = "";
              if (nomeVisual) nomeVisual.textContent = "";
              return;
            }

            // Remove o destaque das outras linhas
            document.querySelectorAll("#listaClientes tr").forEach(tr => tr.classList.remove("table-active"));

            // Adiciona destaque na linha clicada
            linha.classList.add("table-active");

            // Atualiza o input hidden
            if (inputHidden) inputHidden.value = clienteId;

            // Mostra o nome visualmente
            if (nomeVisual) nomeVisual.textContent = `Cliente selecionado: ${clienteNome}`;

            console.log(`Cliente selecionado: ${clienteNome} (ID ${clienteId})`);
          });
        }

        document.addEventListener('DOMContentLoaded', () => {

            const categoryLinks = document.querySelectorAll('#category-filter .nav-link');
            const productCards = document.querySelectorAll('.product-card');
            const searchInput = document.getElementById('product-search');
            const productGrid = document.getElementById('product-grid');
            const cartItemsList = document.getElementById('cart-items');
            const cartEmptyMessage = document.getElementById('cart-empty-message');
            const cartSubtotal = document.getElementById('cart-subtotal');
            const cartTotal = document.getElementById('cart-total');
            const discontPayment = document.getElementById('desconto-pagamento')

                const recalcularTotal = () => {
            const subtotalText = cartSubtotal.textContent
                .replace(/[^\d,.-]/g, '')
                .replace(',', '.');
            const subtotal = parseFloat(subtotalText) || 0;
            const desconto = parseFloat(discontPayment.value) || 0;
            const novoTotal = Math.max(subtotal - desconto, 0);

            cartTotal.textContent = novoTotal.toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
        };

        // 🎯 Atualiza o total sempre que o desconto mudar
        discontPayment.addEventListener('input', recalcularTotal);

            // --- 1. LÓGICA DE FILTRO (CATEGORIA E BUSCA) ---

            const filterProducts = () => {
                const activeCategory = document.querySelector('#category-filter .nav-link.active').getAttribute('data-bs-target-category');
                const searchTerm = searchInput.value.toLowerCase();

                productCards.forEach(card => {
                    const cardCategory = card.getAttribute('data-category-id');
                    const cardName = card.querySelector('.card-title').textContent.toLowerCase();

                    // Condição de Categoria
                    const categoryMatch = (activeCategory === 'all' || activeCategory === cardCategory);

                    // Condição de Busca
                    const searchMatch = (cardName.includes(searchTerm));

                    // Mostrar ou esconder
                    if (categoryMatch && searchMatch) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            };

            // Adiciona evento de clique aos links de categoria
            categoryLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Remove 'active' de todos
                    categoryLinks.forEach(l => l.classList.remove('active'));
                    // Adiciona 'active' ao clicado
                    e.target.classList.add('active');
                    filterProducts();
                });
            });

            // Adiciona evento de "digitar" na busca
            searchInput.addEventListener('input', filterProducts);

            // --- 2. LÓGICA DE ADICIONAR AO CARRINHO ---

            productGrid.addEventListener('click', (e) => {
                const clickedCard = e.target.closest('.product-clickable');
                if (!clickedCard) return; // Não foi um card de produto clicável

                const product = {
                    id: clickedCard.getAttribute('data-product-id'),
                    name: clickedCard.getAttribute('data-product-name'),
                    price: parseFloat(clickedCard.getAttribute('data-product-price'))
                };

                addToCart(product);
            });

            const addToCart = (product) => {
                // Esconde a mensagem de carrinho vazio
                if (cartEmptyMessage) {
                    cartEmptyMessage.style.display = 'none';
                }

                // Verifica se o item já está no carrinho
                const existingItem = cart.find(item => item.id === product.id);

                if (existingItem) {
                    // Se existe, só aumenta a quantidade
                    existingItem.quantity++;
                } else {
                    // Se não existe, adiciona com quantidade 1
                    product.quantity = 1;
                    cart.push(product);
                }

                updateCartUI();
            };

            // --- 3. LÓGICA DE ATUALIZAR O CARRINHO (UI) ---

            const updateCartUI = () => {
                // Limpa a lista antes de redesenhar
                cartItemsList.innerHTML = '';

                let subtotal = 0;

                cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;

                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `
                        <button class="btn btn-sm btn-outline-danger border-0 btn-dim-qtd" data-product-id="${item.id}">
                            <i class="bi bi-dash-circle"></i>
                        </button>
                        <div>
                            <h6 class="mb-0">${item.name}</h6>
                            <small class="text-muted">Qtd: ${item.quantity} x ${formatCurrency(item.price)}</small>
                        </div>
                        <span class="fw-bold">${formatCurrency(itemTotal)}</span>
                        <button class="btn btn-sm btn-outline-danger border-0 btn-remove-item" data-product-id="${item.id}">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    `;
                    cartItemsList.appendChild(li);
                });

                // Atualiza os totais
                cartSubtotal.textContent = formatCurrency(subtotal);
                cartSubtotal.textContent = formatCurrency(subtotal);
                recalcularTotal();

                // Se o carrinho ficar vazio, mostra a mensagem
                if (cart.length === 0 && cartEmptyMessage) {
                    cartItemsList.appendChild(cartEmptyMessage);
                    cartEmptyMessage.style.display = 'block';
                }

                // Mostra o botao do da Pendencia
                const btnPendencia = document.getElementById('btn-pendencia');
                    if (cart.length > 0) {
                        btnPendencia.classList.remove('d-none');
                    } else {
                        btnPendencia.classList.add('d-none');
                    }
            };

            // --- 4. LÓGICA DE REMOVER DO CARRINHO ---

            cartItemsList.addEventListener('click', (e) => {
                const removeButton = e.target.closest('.btn-remove-item');
                if (removeButton) {
                    const productId = removeButton.getAttribute('data-product-id');

                    // Remove o item do array 'cart'
                    cart = cart.filter(item => item.id !== productId);

                    updateCartUI();
                }
                const tirarQtd = e.target.closest('.btn-dim-qtd');
                if(tirarQtd){
                    const productId = tirarQtd.getAttribute('data-product-id');
                    var product = cart.find(prod => prod.id === productId);
                    if(product){
                        product.quantity--;
                        if(product.quantity === 0){
                            cart = cart.filter(item => item.id !== productId);
                        }
                    }
                    updateCartUI();
                }
            });

            // --- 5. LÓGICA DE FINALIZAR VENDA ---
            document.getElementById('btn-finish-sale').addEventListener('click', () => {
                if(cart.length === 0) {
                    const btnFinishSale = document.getElementById('btn-finish-sale');
                    const modalSemProduto = new bootstrap.Modal(document.getElementById('modalPagamentoSemProduto'));
                    modalSemProduto.show();
                    return;
                }

                const btnFinish = document.getElementById('btn-finish-sale');
                const modalFinalizar = new bootstrap.Modal(document.getElementById('modalPagamento'));
                modalFinalizar.show();

                // Limpar carrinho após sucesso
                // cart = [];
                // updateCartUI();
            });

        });


        document.getElementById('btnAddForma').addEventListener('click', () => {
            const container = document.getElementById('formasPagamentoContainer');
            const valorPagar = document.getElementById('total-pagar').textContent
            const btn = document.getElementById('btnAddForma')

            const novaForma = document.createElement('div');
            novaForma.classList.add('row', 'mb-2', 'forma-pagamento');

            if(valorPagar != "R$ 0,00")
            {

            novaForma.innerHTML = `
                <div class="col-md-4">
                    <select class="form-control" name="TipoPagamentoIds">
                        ${document.querySelector('select[name="TipoPagamentoIds"]').innerHTML}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" step="0.01" class="form-control pagamento" name="ValorPagamentos" placeholder="0,00">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                   <button type="button" class="btn btn-danger btn-remove"><i class="bi bi-trash-fill"></i></button>
                </div>
            `;

            } else {
                btn.classList.add('d-none')

                novaForma.innerHTML = `
                <div>
                    <span class="text-danger">O valor de pagamento é ${valorPagar}</span>
                </div>`
            }

            container.appendChild(novaForma);
        });

        // Remover forma de pagamento
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-remove')) {
                e.target.closest('.forma-pagamento').remove();
            }
        });

        function subtotalModal() {
            const valueCart = document.getElementById('cart-total').textContent;
            const valueToModal = document.getElementById('total-value-cart');
            const aPagar = document.getElementById("total-pagar");
            valueToModal.textContent = valueCart
            aPagar.textContent = valueCart
        }

        document.getElementById('modalPagamento').addEventListener('shown.bs.modal', () => {
            const totalText = document.getElementById('cart-total').textContent
                .replace(/[^\d,.-]/g, '')
                .replace(',', '.');
            const total = parseFloat(totalText) || 0;

            const restanteEl = document.getElementById("total-pagar");
            const btn = document.getElementById('btnAddForma');
            const btnRemove = document.getElementById('btn-remove-pagamento');
            const container = document.getElementById('formasPagamentoContainer');

            // 🔹 Função que mostra/esconde o botão de adicionar forma
            function atualizarBotao() {
                const valor = restanteEl.textContent.trim();
                if (valor === "R$ 0,00" || valor === "0,00") {
                    btn.classList.add('d-none'); // esconde botão
                } else {
                    btn.classList.remove('d-none'); // mostra botão
                }
            }

            function atualizarRemove() {
            const inputs = container.querySelectorAll('input[name="ValorPagamentos"]');
            inputs.forEach((inp, index) => {
                const btnRemove = inp.closest('.forma-pagamento')?.querySelector('.btn-remove');
                if (btnRemove) {
                    if (inputs.length > 1) {
                        btnRemove.classList.remove('d-none'); // esconde se só tiver 1 campo
                    } else {
                        btnRemove.classList.add('d-none'); // mostra se tiver 2 ou mais
                    }
                }
            });
        }

            // 🔹 Função que recalcula o restante com base nos inputs
            function atualizarRestante() {
                const inputs = document.querySelectorAll('input[name="ValorPagamentos"]');
                let soma = 0;
                inputs.forEach(input => {
                    soma += parseFloat(input.value) || 0;
                });

                const restante = Math.max(total - soma, 0);
                restanteEl.textContent = `R$ ${restante.toFixed(2).replace('.', ',')}`;
                atualizarBotao(); // atualiza o estado do botão
                atualizarRemove()
            }

            // 🔹 Quando altera algum valor nos inputs, recalcula o restante
            container.addEventListener('input', (e) => {
                if (e.target.name === 'ValorPagamentos') {
                    atualizarRestante();
                }
            });

            // 🔹 Quando clica no botão de remover forma de pagamento
            container.addEventListener('click', (e) => {
                if (e.target.closest('.btn-remove')) {
                    const linha = e.target.closest('.forma-pagamento');
                    linha.remove();
                    atualizarRestante(); // recalcula e reexibe botão se necessário
                }
            });

            // Inicializa ao abrir o modal

            atualizarRestante();
        });

        document.getElementById("formPendencia").addEventListener("submit", function () {

            // Pega total do carrinho
            let total = 0;
            document.querySelectorAll(".item-total").forEach(item => {
                total += parseFloat(item.textContent.replace(",", "."));
            });

            document.getElementById("valorTotal").value = total.toFixed(2);

            // Preenche status
            document.getElementById("statusVenda").value = "Finalizada";

            // Datas automáticas
            const agora = new Date().toISOString();
            document.getElementById("dataEntrada").value = agora;
            document.getElementById("dataAtualizacao").value = agora;

            // Ex.: pagamento selecionado
            // document.getElementById("tipoPagamento").value = document.querySelector("input[name='tipoPagamentoSelecionado']").value;

            // Fechamento (caixa) atual
            // document.getElementById("fechamentoId").value = sessionStorage.getItem("fechamentoId");

        });


    </script>
}