@model PDV.Models.ViewModels.HomeViewModel
@using System.Globalization

@{
    ViewData["Title"] = "PDV - Frente de Caixa";
    var culture = CultureInfo.InvariantCulture;
}

<style>
    /* --- ESTILOS GERAIS E TABELA --- */
    #listaClientes tr.table-active,
    #listaClientes tr.table-active > td {
        background-color: #0d6efd !important;
        color: #fff !important;
        --bs-table-accent-bg: #0d6efd !important;
    }

    #listaClientes tr {
        cursor: pointer;
        transition: background-color 0.1s;
    }

    #listaClientes tr:hover {
        background-color: #e9ecef;
    }

    .over-scroll {
        overflow-y: auto;
        scrollbar-width: thin;
    }

    .product-clickable {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .product-clickable:hover {
        transform: translateY(-4px);
        box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .15) !important;
    }

    /* --- NOVO CSS: PAGAMENTOS MÚLTIPLOS --- */
    .payment-method-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 10px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
        background: #fff;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .payment-method-card:hover {
        border-color: #0d6efd;
        background-color: #f8f9fa;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    .payment-method-card i {
        font-size: 1.5rem;
        margin-bottom: 5px;
        color: #6c757d;
    }

    .payment-method-card:hover i {
        color: #0d6efd;
    }

    /* Linha de pagamento adicionada */
    .payment-row-item {
        background-color: #f8f9fa;
        border-left: 4px solid #0d6efd;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 8px;
        animation: slideIn 0.3s ease;
    }

    @@keyframes slideIn {
        from { opacity: 0; transform: translateX(-10px); }
        to { opacity: 1; transform: translateX(0); }
    }
</style>

@if (Model.Fechamento == null)
{
    <div class="d-flex align-items-center justify-content-center" style="min-height: 80vh;">
        <div class="card shadow-lg col-11 col-md-5 col-lg-4 p-4 text-center">
            <div class="card-body">
                <i class="bi bi-box-arrow-in-right" style="font-size: 3rem; color: var(--bs-primary);"></i>
                <h2 class="card-title mt-3">Caixa Fechado</h2>
                <p class="text-muted">Informe o valor inicial (fundo de troco) para abrir o caixa.</p>

                <form asp-action="AbrirCaixa" asp-controller="Home" method="post" class="mt-4">
                    <div class="input-group mb-3">
                        <span class="input-group-text">R$</span>
                        <input type="number" step="0.01" class="form-control form-control-lg text-end" placeholder="0,00" name="ValorInicial" required autofocus>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg w-100 fw-bold">
                        <i class="bi bi-door-open-fill me-2"></i>
                        ABRIR CAIXA
                    </button>
                </form>
            </div>
        </div>
    </div>
}
else
{
    <div class="container-fluid pt-2">
        <div class="row">
            <div class="col-md-9">
                <div class="mb-2">
                    <input type="text" id="product-search" class="form-control form-control-sm" placeholder="Digite o nome ou código do produto..." style="max-width:50%;">
                </div>

                <ul class="nav nav-pills mb-2" id="category-filter">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-bs-target-category="all">Todos</a>
                    </li>
                    @foreach (var categoria in Model.Categorias)
                    {
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-bs-target-category="@categoria.Id">@categoria.Nome</a>
                        </li>
                    }
                </ul>

                <div class="row pt-2" id="product-grid" style="max-height: 75vh; overflow-y: auto;">
                    @foreach (var produto in Model.Produtos)
                    {
                        <div class="col-xl-2 col-lg-3 col-md-4 mb-2 product-card" data-category-id="@produto.CategoriaId" style="min-height:80px;">
                            <div class="card h-100 shadow-sm product-clickable"
                                 style="cursor: pointer;"
                                 data-product-id="@produto.Id"
                                 data-product-name="@produto.Nome"
                                 data-product-price="@produto.Preco.ToString(culture)">
                                <div class="card-body text-center d-flex flex-column justify-content-center p-2">
                                    <h6 class="card-title mb-1">@produto.Nome</h6>
                                    <span class="card-subtitle text-danger fw-bold small">@produto.Preco.ToString("C")</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="col-md-3">
                <div class="card shadow-sm" style="position: sticky; top: 10px;">
                    <div class="card-header text-center p-2">
                        <h5 class="mb-0">Resumo do Pedido</h5>
                    </div>

                    <ul class="list-group list-group-flush small over-scroll" id="cart-items" style="max-height: 55vh; overflow-y: auto;">
                        <li class="list-group-item text-center text-muted" id="cart-empty-message">
                            Nenhum item adicionado.
                        </li>
                    </ul>

                    <div class="card-body border-top p-2 small">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Subtotal</span>
                            <span id="cart-subtotal">R$ 0,00</span>
                        </div>
                        <hr class="my-1">
                        <div class="row">
                            <div class="col-md-8">
                                <span class="text-muted">Desconto</span>
                            </div>
                            <div class="col-md-4">
                                <input type="number" id="desconto-pagamento" class="form-control form-control-sm" placeholder="0,00" />
                            </div>
                        </div>
                        <hr class="my-1">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-0">Total</h6>
                            <h6 class="mb-0 text-danger fw-bold" id="cart-total">R$ 0,00</h6>
                        </div>
                    </div>

                    <div class="card-footer p-2">
                        <button class="btn btn-success w-100 fw-bold py-2" id="btn-finish-sale" onclick="subtotalModal()">
                            <i class="bi bi-check-circle-fill me-2"></i>Finalizar Venda
                        </button>

                        <div class="d-flex justify-content-between mt-2" id="btn-pendencia">
                            <button class="btn btn-link text-primary p-0 small fw-bold" id="btn-abrir-modal">
                                <i class="bi bi-person-plus-fill me-1"></i>
                                Gerar Pendência
                            </button>

                            <button class="btn btn-link text-danger p-0 small fw-bold"
                                    id="btn-abrir-modal-fechar" type="button">
                                <i class="bi bi-door-closed-fill me-1"></i>
                                Fechar Caixa
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<div class="modal fade" id="modalPagamentoSemProduto" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header p-2">
                <h6 class="modal-title">Atenção</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-2">
                <p>O carrinho está vazio, insira um produto para finalizar a compra!</p>
            </div>
            <div class="modal-footer p-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPagamento" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-wallet2 me-2"></i>Finalizar Venda</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body p-0">
                <div class="row g-0">
                    <div class="col-md-7 p-3 border-end">
                        <h6 class="text-muted mb-3 fw-bold small text-uppercase">Adicionar Pagamento</h6>
                        
                        <div class="row g-2 mb-4">
                            @if (ViewBag.TipoPagamentos != null)
                            {
                                @foreach (var tipo in ViewBag.TipoPagamentos)
                                {
                                    // Define ícone baseado no nome
                                    string icon = "bi-credit-card";
                                    string nome = tipo.Descricao.ToLower();
                                    if (nome.Contains("dinheiro")) icon = "bi-cash-stack";
                                    else if (nome.Contains("pix")) icon = "bi-qr-code";
                                    else if (nome.Contains("débito")) icon = "bi-credit-card-2-front";
                                    
                                    <div class="col-4">
                                        <div class="payment-method-card" onclick="adicionarLinhaPagamento(@tipo.Id, '@tipo.Descricao', '@icon')">
                                            <i class="bi @icon"></i>
                                            <span class="small fw-bold text-truncate w-100">@tipo.Descricao</span>
                                        </div>
                                    </div>
                                }
                            }
                        </div>

                        <h6 class="text-muted mb-2 fw-bold small text-uppercase">Pagamentos Inseridos</h6>
                        
                        <form id="formPagamento" asp-action="Create" asp-controller="Vendas">
                            <input type="hidden" name="ValorTotal" id="valorTotalPagamento" />
                            
                            <div id="listaPagamentosContainer" style="min-height: 150px; max-height: 250px; overflow-y: auto;">
                                <div id="msg-sem-pagamento" class="text-center text-muted mt-4">
                                    <i class="bi bi-arrow-up-circle fs-4"></i>
                                    <p class="small mt-2">Clique nas opções acima para adicionar formas de pagamento.</p>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="col-md-5 bg-light p-3 d-flex flex-column justify-content-between">
                        <div>
                            <h6 class="text-muted fw-bold small text-uppercase mb-3">Resumo Financeiro</h6>
                            
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-secondary">Total da Venda:</span>
                                <span class="fw-bold fs-5" id="resumo-total-venda">R$ 0,00</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-success">Total Pago:</span>
                                <span class="fw-bold fs-5 text-success" id="resumo-total-pago">R$ 0,00</span>
                            </div>
                            <hr />
                            <div class="text-center py-3">
                                <span class="d-block text-muted small text-uppercase fw-bold" id="label-restante">Faltam</span>
                                <h2 class="display-5 fw-bold text-danger" id="resumo-restante">R$ 0,00</h2>
                            </div>
                        </div>

                        <div class="mt-3">
                            <button type="button" class="btn btn-secondary w-100 mb-2" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" form="formPagamento" class="btn btn-success w-100 fw-bold py-2" id="btnConfirmarModal" disabled>
                                <i class="bi bi-check-circle-fill me-2"></i>CONCLUIR VENDA
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPendencia" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header p-2">
                <h6 class="modal-title">Gerar Pendência (Fiado)</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-2">
                <form id="formPendencia" asp-action="Create" asp-controller="Vendas">
                    <input type="hidden" id="clienteSelecionado" name="ClienteId" required />
                    <input type="hidden" name="ValorTotal" id="valorTotal" />
                    <input type="hidden" name="FechamentoId" id="fechamentoId" />

                    <div class="row mb-2">
                        <div class="col-md-12">
                            <div class="input-group mb-3">
                                <input type="text" id="pesquisaCliente" class="form-control form-control-sm" placeholder="Digite nome ou número do cliente...">
                                <button id="btnPesquisar" class="btn btn-primary btn-sm" type="button"><i class="bi bi-search"></i></button>
                            </div>

                            <div style="max-height: 300px; overflow-y: auto;">
                                <table id="cliente-search" class="table table-hover table-striped small d-none">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Nome</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaClientes">
                                        @foreach (var cliente in Model.Clientes)
                                        {
                                            <tr>
                                                <td>@cliente.Id</td>
                                                <td>@cliente.Nome</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                            <div id="msg-nenhum-cliente" class="text-center text-muted small d-none mt-2">Nenhum cliente encontrado.</div>
                            <p id="clienteSelecionadoNome" class="mt-2 fw-bold text-primary border p-2 bg-light rounded text-center" style="display:none;"></p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer p-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="formPendencia" class="btn btn-success btn-sm" id="btnConfirmarPendencia" disabled>Confirmar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalConfirmarFechamento" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="FecharCaixa" asp-controller="Home" method="post" id="form-fechar-caixa">
                <div class="modal-header p-2">
                    <h6 class="modal-title">Fechar Caixa</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-2">
                    <p class="text-muted small">Confirme o valor total em caixa.</p>
                    <div class="input-group">
                        <span class="input-group-text">R$</span>
                        <input type="number" step="0.01" class="form-control form-control-lg text-end"
                               placeholder="0,00" name="ValorFechamento" required autofocus>
                    </div>
                </div>
                <div class="modal-footer p-2">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger btn-sm" id="btn-confirmar-fechar">Sim, Fechar Caixa</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const formatCurrency = (value) => {
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };

        // Estado do carrinho
        let cart = [];

        // --- 1. SELEÇÃO DE CLIENTE ---
        document.addEventListener('click', function (e) {
            const linha = e.target.closest('#listaClientes tr');
            if (!linha) return;

            const inputHidden = document.getElementById("clienteSelecionado");
            const nomeVisual = document.getElementById("clienteSelecionadoNome");
            const btnConfirmar = document.getElementById("btnConfirmarPendencia");

            const clienteId = linha.cells[0].textContent.trim();
            const clienteNome = linha.cells[1].textContent.trim();

            if (linha.classList.contains("table-active")) {
                linha.classList.remove("table-active");
                if (inputHidden) inputHidden.value = "";
                if (nomeVisual) { nomeVisual.textContent = ""; nomeVisual.style.display = "none"; }
                if (btnConfirmar) btnConfirmar.disabled = true;
                return;
            }

            document.querySelectorAll("#listaClientes tr").forEach(tr => tr.classList.remove("table-active"));
            linha.classList.add("table-active");

            if (inputHidden) inputHidden.value = clienteId;
            if (nomeVisual) {
                nomeVisual.textContent = `Cliente Selecionado: ${clienteNome}`;
                nomeVisual.style.display = "block";
            }
            if (btnConfirmar) btnConfirmar.disabled = false;
        });

        // --- DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            const categoryLinks = document.querySelectorAll('#category-filter .nav-link');
            const productCards = document.querySelectorAll('.product-card');
            const searchInput = document.getElementById('product-search');
            const productGrid = document.getElementById('product-grid');
            const cartItemsList = document.getElementById('cart-items');
            const cartEmptyMessage = document.getElementById('cart-empty-message');
            const cartSubtotal = document.getElementById('cart-subtotal');
            const cartTotal = document.getElementById('cart-total');
            const discontPayment = document.getElementById('desconto-pagamento');
            const btnPendencia = document.getElementById('btn-pendencia');

            // --- CARRINHO: CÁLCULOS ---
            const recalcularTotal = () => {
                const subtotalText = cartSubtotal.textContent.replace(/[^\d,.-]/g, '').replace(',', '.');
                const subtotal = parseFloat(subtotalText) || 0;
                const desconto = parseFloat(discontPayment.value) || 0;
                const novoTotal = Math.max(subtotal - desconto, 0);
                cartTotal.textContent = novoTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            };
            discontPayment.addEventListener('input', recalcularTotal);

            // --- CARRINHO: ADICIONAR / REMOVER ---
            productGrid.addEventListener('click', (e) => {
                const clickedCard = e.target.closest('.product-clickable');
                if (!clickedCard) return;
                const product = {
                    id: clickedCard.getAttribute('data-product-id'),
                    name: clickedCard.getAttribute('data-product-name'),
                    price: parseFloat(clickedCard.getAttribute('data-product-price'))
                };
                addToCart(product);
            });

            const addToCart = (product) => {
                if (cartEmptyMessage) cartEmptyMessage.style.display = 'none';
                const existingItem = cart.find(item => item.id === product.id);
                if (existingItem) existingItem.quantity++;
                else { product.quantity = 1; cart.push(product); }
                updateCartUI();
            };

            const updateCartUI = () => {
                cartItemsList.innerHTML = '';
                let subtotal = 0;
                cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex align-items-center';
                    li.innerHTML = `
                        <button class="btn btn-sm btn-outline-danger border-0 btn-dim-qtd" data-product-id="${item.id}"><i class="bi bi-dash-circle"></i></button>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">${item.name}</h6>
                            <small class="text-muted">Qtd: ${item.quantity} x ${formatCurrency(item.price)}</small>
                        </div>
                        <span class="fw-bold mx-3">${formatCurrency(itemTotal)}</span>
                        <button class="btn btn-sm btn-outline-danger border-0 btn-remove-item" data-product-id="${item.id}"><i class="bi bi-trash-fill"></i></button>
                    `;
                    cartItemsList.appendChild(li);
                });
                cartSubtotal.textContent = formatCurrency(subtotal);
                recalcularTotal();
                if (cart.length === 0) {
                    cartItemsList.appendChild(cartEmptyMessage);
                    cartEmptyMessage.style.display = 'block';
                    btnPendencia.classList.add('d-none');
                } else {
                    btnPendencia.classList.remove('d-none');
                }
            };

            cartItemsList.addEventListener('click', (e) => {
                const btnRemove = e.target.closest('.btn-remove-item');
                const btnDim = e.target.closest('.btn-dim-qtd');
                if (btnRemove) {
                    const pid = btnRemove.getAttribute('data-product-id');
                    cart = cart.filter(item => item.id !== pid);
                    updateCartUI();
                } else if (btnDim) {
                    const pid = btnDim.getAttribute('data-product-id');
                    const prod = cart.find(p => p.id === pid);
                    if (prod) {
                        prod.quantity--;
                        if (prod.quantity === 0) cart = cart.filter(item => item.id !== pid);
                    }
                    updateCartUI();
                }
            });

            // --- FILTROS ---
            const filterProducts = () => {
                const activeCategory = document.querySelector('#category-filter .nav-link.active').getAttribute('data-bs-target-category');
                const searchTerm = searchInput.value.toLowerCase();
                productCards.forEach(card => {
                    const cat = card.getAttribute('data-category-id');
                    const name = card.querySelector('.card-title').textContent.toLowerCase();
                    const show = (activeCategory === 'all' || activeCategory === cat) && name.includes(searchTerm);
                    card.style.display = show ? 'block' : 'none';
                });
            };
            categoryLinks.forEach(l => l.addEventListener('click', (e) => {
                e.preventDefault(); categoryLinks.forEach(x => x.classList.remove('active')); e.target.classList.add('active'); filterProducts();
            }));
            searchInput.addEventListener('input', filterProducts);

            // --- FINALIZAR VENDA ---
            document.getElementById('btn-finish-sale').addEventListener('click', () => {
                if (cart.length === 0) {
                    new bootstrap.Modal(document.getElementById('modalPagamentoSemProduto')).show();
                    return;
                }
                new bootstrap.Modal(document.getElementById('modalPagamento')).show();
            });

            // --- MODAL PENDÊNCIA ---
            const modalPendenciaEl = document.getElementById('modalPendencia');
            const modalPendencia = new bootstrap.Modal(modalPendenciaEl);
            const btnAbrirPendencia = document.getElementById('btn-abrir-modal');
            if (btnAbrirPendencia) btnAbrirPendencia.addEventListener('click', () => modalPendencia.show());

            // Lógica de pesquisa cliente
            const btnPesquisarCliente = document.getElementById("btnPesquisar");
            const inputPesquisaCliente = document.getElementById("pesquisaCliente");
            function filtrarClientes() {
                const termo = inputPesquisaCliente.value.toLowerCase().trim();
                const tabela = document.getElementById("cliente-search");
                const linhas = document.querySelectorAll("#listaClientes tr");
                const msgNenhum = document.getElementById("msg-nenhum-cliente");
                tabela.classList.remove("d-none");
                let encontrou = false;
                linhas.forEach(linha => {
                    const texto = linha.innerText.toLowerCase();
                    if (termo === "" || texto.includes(termo)) { linha.style.display = ""; encontrou = true; }
                    else linha.style.display = "none";
                });
                if (msgNenhum) msgNenhum.classList.toggle("d-none", encontrou);
                if(!encontrou && termo !== "") tabela.classList.add("d-none");
            }
            if (btnPesquisarCliente) btnPesquisarCliente.addEventListener("click", filtrarClientes);
            if (inputPesquisaCliente) inputPesquisaCliente.addEventListener("input", filtrarClientes);
            modalPendenciaEl.addEventListener('shown.bs.modal', function () {
                document.getElementById("pesquisaCliente").value = "";
                document.getElementById("clienteSelecionado").value = "";
                document.getElementById("clienteSelecionadoNome").style.display = "none";
                document.getElementById("btnConfirmarPendencia").disabled = true;
                document.querySelectorAll("#listaClientes tr").forEach(tr => tr.classList.remove("table-active"));
                filtrarClientes();
            });
            
            // --- MODAL FECHAR CAIXA ---
            const btnModalFechar = document.getElementById('btn-abrir-modal-fechar');
            if(btnModalFechar) {
                btnModalFechar.addEventListener('click', (e) => {
                    e.preventDefault();
                    new bootstrap.Modal(document.getElementById('modalConfirmarFechamento')).show();
                });
                document.getElementById('form-fechar-caixa').addEventListener('submit', function() {
                     const btn = document.getElementById('btn-confirmar-fechar');
                     btn.disabled = true;
                     btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Fechando...';
                });
            }
        });

        // ======================================================================
        // --- LÓGICA REESTILIZADA PARA MÚLTIPLOS PAGAMENTOS (MODAL) ---
        // ======================================================================

        // Função chamada pelo botão "Finalizar Venda" (onclick no HTML)
        function subtotalModal() {
            // Pega o valor total do carrinho (texto formatado R$)
            const valorTexto = document.getElementById('cart-total').textContent;
            document.getElementById('resumo-total-venda').textContent = valorTexto;
            
            // Limpa pagamentos anteriores
            document.getElementById('listaPagamentosContainer').innerHTML = `
                 <div id="msg-sem-pagamento" class="text-center text-muted mt-4">
                    <i class="bi bi-arrow-up-circle fs-4"></i>
                    <p class="small mt-2">Clique nas opções acima para adicionar formas de pagamento.</p>
                </div>`;
            
            atualizarResumoFinanceiro();
        }

        // Função chamada ao clicar nos CARDS de pagamento
        function adicionarLinhaPagamento(id, nome, iconClass) {
            const container = document.getElementById('listaPagamentosContainer');
            const msgVazio = document.getElementById('msg-sem-pagamento');
            if(msgVazio) msgVazio.remove();

            // Calcula quanto falta pagar para preencher o input automaticamente
            const totalVenda = getMoneyValue(document.getElementById('resumo-total-venda').textContent);
            const totalJaPago = calcularTotalPagoNosInputs();
            let restante = Math.max(totalVenda - totalJaPago, 0);
            
            // Se já pagou tudo, adiciona zerado (para caso queira ajustar) ou barra?
            // UX decision: Permite adicionar, mas vem 0.
            
            const novoId = 'pag_' + Date.now(); // ID único para o DOM

            const div = document.createElement('div');
            div.className = 'payment-row-item';
            div.id = novoId;
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <div class="d-flex align-items-center">
                        <i class="bi ${iconClass} me-2 text-primary"></i>
                        <span class="fw-bold small">${nome}</span>
                    </div>
                    <button type="button" class="btn btn-sm text-danger p-0" onclick="removerLinhaPagamento('${novoId}')">
                        <i class="bi bi-trash-fill"></i>
                    </button>
                </div>
                <div class="input-group input-group-sm">
                    <span class="input-group-text">R$</span>
                    <input type="hidden" name="TipoPagamentoId" value="${id}">
                    <input type="number" step="0.01" class="form-control fw-bold text-end" 
                           name="ValorPagamentos" value="${restante.toFixed(2)}" 
                           oninput="atualizarResumoFinanceiro()">
                </div>
            `;
            
            container.appendChild(div);
            atualizarResumoFinanceiro();
        }

        function removerLinhaPagamento(idElemento) {
            document.getElementById(idElemento).remove();
            
            // Se ficou vazio, mostra a mensagem de novo
            const container = document.getElementById('listaPagamentosContainer');
            if(container.children.length === 0) {
                container.innerHTML = `
                 <div id="msg-sem-pagamento" class="text-center text-muted mt-4">
                    <i class="bi bi-arrow-up-circle fs-4"></i>
                    <p class="small mt-2">Clique nas opções acima para adicionar formas de pagamento.</p>
                </div>`;
            }
            atualizarResumoFinanceiro();
        }

        function calcularTotalPagoNosInputs() {
            const inputs = document.querySelectorAll('input[name="ValorPagamentos"]');
            let soma = 0;
            inputs.forEach(inp => soma += parseFloat(inp.value) || 0);
            return soma;
        }

        function getMoneyValue(text) {
            return parseFloat(text.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
        }

        function formatMoney(val) {
            return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function atualizarResumoFinanceiro() {
            const totalVenda = getMoneyValue(document.getElementById('resumo-total-venda').textContent);
            const totalPago = calcularTotalPagoNosInputs();
            
            // Atualiza labels
            document.getElementById('resumo-total-pago').textContent = formatMoney(totalPago);
            
            const restante = totalVenda - totalPago;
            const elRestante = document.getElementById('resumo-restante');
            const labelRestante = document.getElementById('label-restante');
            const btnConfirmar = document.getElementById('btnConfirmarModal');

            if (restante > 0.01) {
                // Falta pagar
                elRestante.textContent = formatMoney(restante);
                elRestante.className = 'display-5 fw-bold text-danger';
                labelRestante.textContent = 'FALTAM';
                btnConfirmar.disabled = true;
            } else if (restante < -0.01) {
                // Troco
                elRestante.textContent = formatMoney(Math.abs(restante));
                elRestante.className = 'display-5 fw-bold text-primary';
                labelRestante.textContent = 'TROCO';
                btnConfirmar.disabled = false; // Pode fechar com troco
            } else {
                // Zerado (Pago exato)
                elRestante.textContent = 'R$ 0,00';
                elRestante.className = 'display-5 fw-bold text-success';
                labelRestante.textContent = 'CONCLUÍDO';
                btnConfirmar.disabled = false;
            }
        }

        // --- SUBMISSÃO FORMULÁRIOS ---
        function prepareForm(form) {
            // Limpa inputs antigos de produtos
            form.querySelectorAll('input[name^="ProdutosVenda"]').forEach(e => e.remove());
            
            const totalClean = document.getElementById('cart-total').textContent.replace("R$", "").trim();

            // Preenche inputs de total
            const inTotalPen = form.querySelector('#valorTotal');
            const inTotalPag = form.querySelector('#valorTotalPagamento');
            if(inTotalPen) inTotalPen.value = totalClean;
            if(inTotalPag) inTotalPag.value = totalClean;

            // Adiciona os produtos do carrinho JS no form HTML
            cart.forEach((item, i) => {
                const id = document.createElement('input'); id.type='hidden'; id.name=`ProdutosVenda[${i}].ProdutoId`; id.value=item.id; form.appendChild(id);
                const qt = document.createElement('input'); qt.type='hidden'; qt.name=`ProdutosVenda[${i}].Quantidade`; qt.value=item.quantity; form.appendChild(qt);
            });
        }

        document.getElementById("formPendencia").addEventListener("submit", function(e) {
            e.preventDefault();
            prepareForm(this);
            this.submit();
        });

        document.getElementById("formPagamento").addEventListener("submit", function(e) {
            prepareForm(this);
            // Permite submit
        });

    </script>
}