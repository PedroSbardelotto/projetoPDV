@model PDV.Models.ViewModels.HomeViewModel
@using System.Globalization

@{
    ViewData["Title"] = "Home Page";
    // Essencial para formatar R$ e para o JavaScript entender os números
    var culture = CultureInfo.InvariantCulture;
}

<!-- TROCAR ESSE IGUAL PARA DIFERENTE PARA MEXER NO RESTANTE-->
@if (Model.Fechamento == null)
{
    <div class="d-flex align-items-center justify-content-center" style="min-height: 80vh;">

        <div class="card shadow-lg col-11 col-md-5 col-lg-4 p-4 text-center">

            <div class="card-body">
                <i class="bi bi-box-arrow-in-right" style="font-size: 3rem; color: var(--bs-primary);"></i>
                <h2 class="card-title mt-3">Caixa Fechado</h2>
                <p class="text-muted">Informe o valor inicial (fundo de troco) para abrir o caixa e começar as vendas.</p>

                <form asp-action="AbrirCaixa" asp-controller="Home" method="post" class="mt-4">
                    <div class="input-group mb-3">
                        <span class="input-group-text">R$</span>
                        <input type="number" step="0.01" class="form-control form-control-lg text-end" placeholder="0,00" name="ValorInicial" required autofocus>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg w-100 fw-bold">
                        <i class="bi bi-door-open-fill me-2"></i>
                        ABRIR CAIXA
                    </button>
                </form>
            </div>
        </div>
    </div>
}
else
{
    <div class="container-fluid pt-2">
        <div class="row">

            <div class="col-md-9">
                <div class="mb-2">
                    <input type="text" id="product-search" class="form-control form-control-sm" placeholder="Digite o nome ou código do produto..." style="max-width:50%;">
                </div>

                <ul class="nav nav-pills mb-2" id="category-filter">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-bs-target-category="all">Todos</a>
                    </li>
                    @foreach (var categoria in Model.Categorias)
                    {
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-bs-target-category="@categoria.Id">@categoria.Nome</a>
                        </li>
                    }
                </ul>

                <div class="row pt-2" id="product-grid" style="max-height: 75vh; overflow-y: auto;">
                    @foreach (var produto in Model.Produtos)
                    {
                        <div class="col-xl-2 col-lg-3 col-md-4 mb-2 product-card" data-category-id="@produto.CategoriaId" style="min-height:80px;">
                            <div class="card h-100 shadow-sm product-clickable"
                                 style="cursor: pointer;"
                                 data-product-id="@produto.Id"
                                 data-product-name="@produto.Nome"
                                 data-product-price="@produto.Preco.ToString(culture)">
                                <div class="card-body text-center d-flex flex-column justify-content-center p-2">
                                    <h6 class="card-title mb-1">@produto.Nome</h6>
                                    <span class="card-subtitle text-danger fw-bold small">@produto.Preco.ToString("C")</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="col-md-3">
                <div class="card shadow-sm" style="position: sticky; top: 10px;">
                    <div class="card-header text-center p-2">
                        <h5 class="mb-0">Resumo do Pedido</h5>
                    </div>

                    <ul class="list-group list-group-flush small over-scroll" id="cart-items" style="max-height: 55vh; overflow-y: auto;">
                        <li class="list-group-item text-center text-muted" id="cart-empty-message">
                            Nenhum item adicionado.
                        </li>
                    </ul>

                    <div class="card-body border-top p-2 small">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Subtotal</span>
                            <span id="cart-subtotal">R$ 0,00</span>
                        </div>
                        <hr class="my-1">
                        <div class="row">
                            <div class="col-md-8">
                                <span class="text-muted">Desconto</span>
                            </div>
                            <div class="col-md-4">
                                <input type="number" id="desconto-pagamento" class="form-control form-control-sm" placeholder="0,00" />
                            </div>
                        </div>
                        <hr class="my-1">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-0">Total</h6>
                            <h6 class="mb-0 text-danger fw-bold" id="cart-total">R$ 0,00</h6>
                        </div>
                    </div>

                    <div class="card-footer p-2">
                        <button class="btn btn-success w-100 fw-bold py-2" id="btn-finish-sale" onclick="subtotalModal()">
                            <i class="bi bi-check-circle-fill me-2"></i>Finalizar Venda
                        </button>

                        <div class="d-flex justify-content-between mt-2" id="btn-pendencia">
                            <button class="btn btn-link text-primary p-0 small fw-bold" id="btn-abrir-modal">
                                <i class="bi bi-person-plus-fill me-1"></i>
                                Gerar Pendência
                            </button>

                            <button class="btn btn-link text-danger p-0 small fw-bold"
                                    id="btn-abrir-modal-fechar" type="button">
                                <i class="bi bi-door-closed-fill me-1"></i>
                                Fechar Caixa
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
}

<div class="modal fade" id="modalPagamentoSemProduto" tabindex="-1" aria-labelledby="modalPagamentoSemProdutoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header p-2">
                <h6 class="modal-title" id="modalPagamentoLabel">Atenção</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body p-2">
                <p class="">O carrinho está vazio, insira um produto para finalizar a compra!</p>
            </div>
            <div class="modal-footer p-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPagamento" tabindex="-1" aria-labelledby="modalPagamentoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header p-2">
                <h6 class="modal-title" id="modalPagamentoLabel">Selecionar Tipo de Pagamento</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body p-2">
                <div class="row">
                    <div class="col-md-8">
                        <form id="formPagamento" asp-action="Create" asp-controller="Vendas">
                            <input type="hidden" name="ValorTotal" id="valorTotalPagamento" />

                            <div id="formasPagamentoContainer">
                                <div class="row mb-2 forma-pagamento small">
                                    <div class="col-md-4">
                                        <label for="TipoPagamento_0" class="form-label">Forma de Pagamento</label>
                                        <select class="form-control form-control-sm" name="TipoPagamentoId">
                                            @foreach (var tipo in ViewBag.TipoPagamentos)
                                            {
                                                <option value="@tipo.Id">@tipo.Descricao</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Valor (R$)</label>
                                        <input type="number" id="pagamento" step="0.01" class="form-control form-control-sm" name="ValorPagamentos" placeholder="0,00">
                                    </div>
                                    <div class="col-md-1 d-flex align-items-end">
                                        <button type="button" class="btn btn-danger btn-sm btn-remove d-none"><i class="bi bi-trash-fill"></i></button>
                                    </div>
                                </div>
                            </div>

                            <button type="button" class="btn btn-outline-primary btn-sm mt-1" id="btnAddForma">
                                Adicinar
                            </button>
                        </form>
                    </div>

                    <div class="col-md-4 border p-2 small">
                        <div class="row mt-1">
                            <p class="col-md-6 text-secondary">Subtotal: </p>
                            <p id="total-value-cart" class="col-md-6"></p>
                        </div>
                        <hr class="my-1">
                        <div class="row">
                            <p class="col-md-6">Total a pagar:</p>
                            <p id="total-pagar" class="col-md-6 text-danger fw-bold fs-6"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer p-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="formPagamento" class="btn btn-success btn-sm">Confirmar Pagamento</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPendencia" tabindex="-1" aria-labelledby="modalPendenciaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header p-2">
                <h6 class="modal-title" id="modalPagamentoLabel">Atenção</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body p-2">
                <form id="formPendencia" asp-action="Create" asp-controller="Vendas">
                    <input type="hidden" id="clienteSelecionado" name="ClienteId" />
                    <input type="hidden" name="ValorTotal" id="valorTotal" />
                    <input type="hidden" name="FechamentoId" id="fechamentoId" />

                    <div id="formasPagamentoContainer">
                        <div class="row mb-2 forma-pagamento">
                            <div class="col-md-12">
                                <div class="">
                                    <div class="input-group mb-3">
                                        <input type="text" id="pesquisaCliente" class="form-control form-control-sm" placeholder="Digite nome ou número do cliente...">
                                        <button id="btnPesquisar" class="btn btn-primary btn-sm" type="button"><i class="bi bi-search"></i></button>
                                    </div>

                                    <table id="cliente-search" class="table table-striped d-none">
                                        <thead>
                                            <tr>
                                                <th>Número</th>
                                                <th>Nome</th>
                                            </tr>
                                        </thead>
                                        <tbody id="listaClientes">
                                            @foreach (var cliente in Model.Clientes)
                                            {
                                                <tr>
                                                    <td>@cliente.Id</td>
                                                    <td>@cliente.Nome</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                    <p id="clienteSelecionadoNome" class="mt-2 fw-bold text-primary"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer p-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="formPendencia" class="btn btn-success btn-sm">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalConfirmarFechamento" tabindex="-1" aria-labelledby="confirmarFechamentoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="FecharCaixa" asp-controller="Home" method="post" id="form-fechar-caixa">
                <div class="modal-header p-2">
                    <h6 class="modal-title" id="confirmarFechamentoLabel">Fechar Caixa</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body p-2">
                    <p class="text-muted small">Confirme o valor total (dinheiro + outros pagamentos) contado no caixa para encerrar as vendas de hoje.</p>

                    <div class="input-group">
                        <span class="input-group-text">R$</span>
                        <input type="number" step="0.01" class="form-control form-control-lg text-end"
                               placeholder="0,00" name="ValorFechamento" required autofocus>
                    </div>
                </div>
                <div class="modal-footer p-2">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger btn-sm" id="btn-confirmar-fechar">Sim, Fechar Caixa</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    /* Faz a linha parecer clicável */
    #listaClientes tr {
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
    }

        /* Quando a linha é selecionada */
        #listaClientes tr.table-active {
            background-color: #0d6efd !important; /* azul padrão Bootstrap */
            color: #fff !important;
            font-weight: 600;
        }
</style>

@section Scripts {
    <script>
        // Função para formatar moeda (para exibir no carrinho)
        const formatCurrency = (value) => {
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };

        // Estado do carrinho (um array de objetos)
        let cart = [];

        document.getElementById('btn-abrir-modal').addEventListener('click', () => {
                const bntPendencia = document.getElementById('modalPendencia')
                const modalPendencia = new bootstrap.Modal(bntPendencia);
                modalPendencia.show()
                return
            })

        document.getElementById("btnPesquisar").addEventListener("click", function () {
            const termo = document.getElementById("pesquisaCliente").value.toLowerCase().trim();
            const showClient = document.getElementById("cliente-search");
            const linhas = document.querySelectorAll("#listaClientes tr");
            const msgNenhum = document.getElementById("msg-nenhum");

            // Se o campo estiver vazio, não faz a busca
            if (!termo) {
                return;
            }

            showClient.classList.remove("d-none");

            let encontrou = false;

            linhas.forEach(linha => {
                const numero = linha.children[0].textContent.toLowerCase();
                const nome = linha.children[1].textContent.toLowerCase();

                if (numero.includes(termo) || nome.includes(termo)) {
                    linha.style.display = "";
                    encontrou = true;
                } else {
                    linha.style.display = "none";
                }
            });

            // Exibe ou oculta a linha de "nenhum resultado"
            if (msgNenhum) {
                msgNenhum.style.display = encontrou ? "none" : "";
            }
        });

        const listaClientes = document.getElementById("listaClientes");

        if (listaClientes) {
          listaClientes.addEventListener("click", function (e) {
            const linha = e.target.closest("tr");
            if (!linha) return;
            if (linha.style.display === "none") return;

            const inputHidden = document.getElementById("clienteSelecionado");
            const nomeVisual = document.getElementById("clienteSelecionadoNome");

            const clienteId = linha.children[0].textContent.trim();
            const clienteNome = linha.children[1].textContent.trim();

            // Se já está selecionado, desseleciona
            if (linha.classList.contains("table-active")) {
              linha.classList.remove("table-active");
              if (inputHidden) inputHidden.value = "";
              if (nomeVisual) nomeVisual.textContent = "";
              return;
            }

            // Remove o destaque das outras linhas
            document.querySelectorAll("#listaClientes tr").forEach(tr => tr.classList.remove("table-active"));

            // Adiciona destaque na linha clicada
            linha.classList.add("table-active");

            // Atualiza o input hidden
            if (inputHidden) inputHidden.value = clienteId;

            // Mostra o nome visualmente
            if (nomeVisual) nomeVisual.textContent = `Cliente selecionado: ${clienteNome}`;

            console.log(`Cliente selecionado: ${clienteNome} (ID ${clienteId})`);
          });
        }

        document.addEventListener('DOMContentLoaded', () => {

            const categoryLinks = document.querySelectorAll('#category-filter .nav-link');
            const productCards = document.querySelectorAll('.product-card');
            const searchInput = document.getElementById('product-search');
            const productGrid = document.getElementById('product-grid');
            const cartItemsList = document.getElementById('cart-items');
            const cartEmptyMessage = document.getElementById('cart-empty-message');
            const cartSubtotal = document.getElementById('cart-subtotal');
            const cartTotal = document.getElementById('cart-total');
            const discontPayment = document.getElementById('desconto-pagamento')

                const recalcularTotal = () => {
            const subtotalText = cartSubtotal.textContent
                .replace(/[^\d,.-]/g, '')
                .replace(',', '.');
            const subtotal = parseFloat(subtotalText) || 0;
            const desconto = parseFloat(discontPayment.value) || 0;
            const novoTotal = Math.max(subtotal - desconto, 0);

            cartTotal.textContent = novoTotal.toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
        };

        // 🎯 Atualiza o total sempre que o desconto mudar
        discontPayment.addEventListener('input', recalcularTotal);

            // --- 1. LÓGICA DE FILTRO (CATEGORIA E BUSCA) ---

            const filterProducts = () => {
                const activeCategory = document.querySelector('#category-filter .nav-link.active').getAttribute('data-bs-target-category');
                const searchTerm = searchInput.value.toLowerCase();

                productCards.forEach(card => {
                    const cardCategory = card.getAttribute('data-category-id');
                    const cardName = card.querySelector('.card-title').textContent.toLowerCase();

                    // Condição de Categoria
                    const categoryMatch = (activeCategory === 'all' || activeCategory === cardCategory);

                    // Condição de Busca
                    const searchMatch = (cardName.includes(searchTerm));

                    // Mostrar ou esconder
                    if (categoryMatch && searchMatch) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            };

            // Adiciona evento de clique aos links de categoria
            categoryLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Remove 'active' de todos
                    categoryLinks.forEach(l => l.classList.remove('active'));
                    // Adiciona 'active' ao clicado
                    e.target.classList.add('active');
                    filterProducts();
                });
            });

            // Adiciona evento de "digitar" na busca
            searchInput.addEventListener('input', filterProducts);

            // --- 2. LÓGICA DE ADICIONAR AO CARRINHO ---

            productGrid.addEventListener('click', (e) => {
                const clickedCard = e.target.closest('.product-clickable');
                if (!clickedCard) return; // Não foi um card de produto clicável

                const product = {
                    id: clickedCard.getAttribute('data-product-id'),
                    name: clickedCard.getAttribute('data-product-name'),
                    price: parseFloat(clickedCard.getAttribute('data-product-price'))
                };

                addToCart(product);
            });

            const addToCart = (product) => {
                // Esconde a mensagem de carrinho vazio
                if (cartEmptyMessage) {
                    cartEmptyMessage.style.display = 'none';
                }

                // Verifica se o item já está no carrinho
                const existingItem = cart.find(item => item.id === product.id);

                if (existingItem) {
                    // Se existe, só aumenta a quantidade
                    existingItem.quantity++;
                } else {
                    // Se não existe, adiciona com quantidade 1
                    product.quantity = 1;
                    cart.push(product);
                }

                updateCartUI();
            };

            // --- 3. LÓGICA DE ATUALIZAR O CARRINHO (UI) ---

            const updateCartUI = () => {
                // Limpa a lista antes de redesenhar
                cartItemsList.innerHTML = '';

                let subtotal = 0;

                cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;

                    const li = document.createElement('li');
                    // Correção de layout com flex-grow-1
                    li.className = 'list-group-item d-flex align-items-center';
                    li.innerHTML = `
                        <button class="btn btn-sm btn-outline-danger border-0 btn-dim-qtd" data-product-id="${item.id}">
                            <i class="bi bi-dash-circle"></i>
                        </button>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">${item.name}</h6>
                            <small class="text-muted">Qtd: ${item.quantity} x ${formatCurrency(item.price)}</small>
                        </div>
                        <span class="fw-bold mx-3">${formatCurrency(itemTotal)}</span>
                        <button class="btn btn-sm btn-outline-danger border-0 btn-remove-item" data-product-id="${item.id}">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    `;
                    cartItemsList.appendChild(li);
                });

                // Atualiza os totais
                cartSubtotal.textContent = formatCurrency(subtotal);
                recalcularTotal(); // Já recalcula o total com desconto

                // Se o carrinho ficar vazio, mostra a mensagem
                if (cart.length === 0 && cartEmptyMessage) {
                    cartItemsList.appendChild(cartEmptyMessage);
                    cartEmptyMessage.style.display = 'block';
                }

                // Mostra o botao do da Pendencia
                const btnPendencia = document.getElementById('btn-pendencia');
                    if (cart.length > 0) {
                        btnPendencia.classList.remove('d-none');
                    } else {
                        btnPendencia.classList.add('d-none');
                    }
            };

            // --- 4. LÓGICA DE REMOVER DO CARRINHO ---

            cartItemsList.addEventListener('click', (e) => {
                const removeButton = e.target.closest('.btn-remove-item');
                if (removeButton) {
                    const productId = removeButton.getAttribute('data-product-id');

                    // Remove o item do array 'cart'
                    cart = cart.filter(item => item.id !== productId);

                    updateCartUI();
                }
                const tirarQtd = e.target.closest('.btn-dim-qtd');
                if(tirarQtd){
                    const productId = tirarQtd.getAttribute('data-product-id');
                    var product = cart.find(prod => prod.id === productId);
                    if(product){
                        product.quantity--;
                        if(product.quantity === 0){
                            cart = cart.filter(item => item.id !== productId);
                        }
                    }
                    updateCartUI();
                }
            });

            // --- 5. LÓGICA DE FINALIZAR VENDA ---
            document.getElementById('btn-finish-sale').addEventListener('click', () => {
                if(cart.length === 0) {
                    const btnFinishSale = document.getElementById('btn-finish-sale');
                    const modalSemProduto = new bootstrap.Modal(document.getElementById('modalPagamentoSemProduto'));
                    modalSemProduto.show();
                    return;
                }

                const btnFinish = document.getElementById('btn-finish-sale');
                const modalFinalizar = new bootstrap.Modal(document.getElementById('modalPagamento'));
                modalFinalizar.show();

                // Limpar carrinho após sucesso
                // cart = [];
                // updateCartUI();
            });

            const modalFecharEl = document.getElementById('modalConfirmarFechamento');
            if (modalFecharEl) {
                const modalFechar = new bootstrap.Modal(modalFecharEl);

                // 1. Botão que ABRE o modal (está correto)
                const btnAbrirModalFechar = document.getElementById('btn-abrir-modal-fechar');
                if (btnAbrirModalFechar) {
                    btnAbrirModalFechar.addEventListener('click', (e) => {
                        e.preventDefault();
                        modalFechar.show();
                    });
                }

                // 2. Pegamos o FORMULÁRIO e o BOTÃO de confirmação
                const formFecharCaixa = document.getElementById('form-fechar-caixa');
                const btnConfirmarFechar = document.getElementById('btn-confirmar-fechar');

                if (formFecharCaixa && btnConfirmarFechar) {

                    // 3. MUDANÇA: Escutamos o 'submit' DO FORMULÁRIO
                    formFecharCaixa.addEventListener('submit', () => {

                        // 4. AGORA sim desabilitamos o botão.
                        // A submissão já foi iniciada e não será cancelada.
                        btnConfirmarFechar.disabled = true;
                        btnConfirmarFechar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Fechando...';
                    });
                }
            }
        });


        document.getElementById('btnAddForma').addEventListener('click', () => {
            const container = document.getElementById('formasPagamentoContainer');
            const valorPagar = document.getElementById('total-pagar').textContent
            const btn = document.getElementById('btnAddForma')

            const novaForma = document.createElement('div');
            novaForma.classList.add('row', 'mb-2', 'forma-pagamento', 'small'); // Adicionado .small

            if(valorPagar != "R$ 0,00")
            {

            novaForma.innerHTML = `
                <div class="col-md-4">
                    <select class="form-control form-control-sm" name="TipoPagamentoId">
                        ${document.querySelector('select[name="TipoPagamentoId"]').innerHTML}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" step="0.01" class="form-control form-control-sm pagamento" name="ValorPagamentos" placeholder="0,00">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                   <button type="button" class="btn btn-danger btn-sm btn-remove"><i class="bi bi-trash-fill"></i></button>
                </div>
            `;

            } else {
                btn.classList.add('d-none')

                novaForma.innerHTML = `
                <div>
                    <span class="text-danger">O valor de pagamento é ${valorPagar}</span>
                </div>`
            }

            container.appendChild(novaForma);
        });

        // Remover forma de pagamento
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-remove')) {
                e.target.closest('.forma-pagamento').remove();
            }
        });

        function subtotalModal() {
            const valueCart = document.getElementById('cart-total').textContent;
            const valueToModal = document.getElementById('total-value-cart');
            const aPagar = document.getElementById("total-pagar");
            valueToModal.textContent = valueCart
            aPagar.textContent = valueCart
        }

        document.getElementById('modalPagamento').addEventListener('shown.bs.modal', () => {
            const totalText = document.getElementById('cart-total').textContent
                .replace(/[^\d,.-]/g, '')
                .replace(',', '.');
            const total = parseFloat(totalText) || 0;

            const restanteEl = document.getElementById("total-pagar");
            const btn = document.getElementById('btnAddForma');
            const btnRemove = document.getElementById('btn-remove-pagamento');
            const container = document.getElementById('formasPagamentoContainer');

            // 🔹 Função que mostra/esconde o botão de adicionar forma
            function atualizarBotao() {
                const valor = restanteEl.textContent.trim();
                if (valor === "R$ 0,00" || valor === "0,00") {
                    btn.classList.add('d-none'); // esconde botão
                } else {
                    btn.classList.remove('d-none'); // mostra botão
                }
            }

            function atualizarRemove() {
            const inputs = container.querySelectorAll('input[name="ValorPagamentos"]');
            inputs.forEach((inp, index) => {
                const btnRemove = inp.closest('.forma-pagamento')?.querySelector('.btn-remove');
                if (btnRemove) {
                    if (inputs.length > 1) {
                        btnRemove.classList.remove('d-none'); // mostra se tiver 2 ou mais
                    } else {
                        btnRemove.classList.add('d-none'); // esconde se só tiver 1 campo
                    }
                }
            });
        }

            // 🔹 Função que recalcula o restante com base nos inputs
            function atualizarRestante() {
                const inputs = document.querySelectorAll('input[name="ValorPagamentos"]');
                let soma = 0;
                inputs.forEach(input => {
                    soma += parseFloat(input.value) || 0;
                });

                const restante = Math.max(total - soma, 0);
                restanteEl.textContent = `R$ ${restante.toFixed(2).replace('.', ',')}`;
                atualizarBotao(); // atualiza o estado do botão
                atualizarRemove()
            }

            // 🔹 Quando altera algum valor nos inputs, recalcula o restante
            container.addEventListener('input', (e) => {
                if (e.target.name === 'ValorPagamentos') {
                    atualizarRestante();
                }
            });

            // 🔹 Quando clica no botão de remover forma de pagamento
            container.addEventListener('click', (e) => {
                if (e.target.closest('.btn-remove')) {
                    const linha = e.target.closest('.forma-pagamento');
                    linha.remove();
                    atualizarRestante(); // recalcula e reexibe botão se necessário
                }
            });

            // Inicializa ao abrir o modal

            atualizarRestante();
        });

                document.getElementById("formPendencia").addEventListener("submit", function (event) {
            event.preventDefault(); // <- Impede envio precoce !!

            const form = this;

            // Remove inputs antigos
            form.querySelectorAll('input[name^="ItensVendaIds"], input[name^="Quantidades"]').forEach(input => input.remove());

            // Pega total
            const totalText = document.getElementById('cart-total').textContent;

            const valorSanitizado = totalText
                .replace("R$", "")
                .replace(/\s/g, "")
                .replace(/\./g, "")

            document.getElementById("valorTotal").value = valorSanitizado;

            console.log("ValorTotal enviado:", valorSanitizado);

            // Loop dos itens
            cart.forEach((item, index) => {
                const inputId = document.createElement('input');
                inputId.type = 'hidden';
                inputId.name = `ProdutosVenda[${index}].ProdutoId`;
                inputId.value = item.id;
                form.appendChild(inputId);

                const inputQtd = document.createElement('input');
                inputQtd.type = 'hidden';
                inputQtd.name = `ProdutosVenda[${index}].Quantidade`;
                inputQtd.value = item.quantity;
                form.appendChild(inputQtd);

                console.log(`Item adicionado: ID=${item.id}, Qtd=${item.quantity}`);
            });

            // Agora sim: envia o form corretamente
            form.submit();
        });

        document.getElementById("formPagamento").addEventListener("submit", function () {

            const form = this;

            // 1. Limpa quaisquer inputs de ItemVendaIds e Quantidades anteriores (para evitar duplicatas)
            form.querySelectorAll('input[name^="ItensVendaIds"], input[name^="Quantidades"]').forEach(input => input.remove());

            // Pega total do carrinho
            const totalText = document.getElementById('total-value-cart').textContent;
            console.log(totalText)
            const valorSanitizado = totalText
                .replace("R$", "")
                .replace(/\s/g, "")
                .replace(/\./g, "")

            document.getElementById("valorTotalPagamento").value = valorSanitizado;

            cart.forEach((item, index) => {
                // Input para o ID do Produto (ou Id do Item de Venda, se o nome for diferente no backend)
                const inputId = document.createElement('input');
                inputId.type = 'hidden';
                inputId.name = `ProdutosVenda[${index}].ProdutoId`; // Ou 'ItensVenda[${index}].ProdutoId' dependendo do seu Model Binder no C#
                inputId.value = item.id;
                form.appendChild(inputId);

                // Input para a Quantidade
                const inputQtd = document.createElement('input');
                inputQtd.type = 'hidden';
                inputQtd.name = `ProdutosVenda[${index}].Quantidade`; // Ou 'ItensVenda[${index}].Quantidade'
                inputQtd.value = item.quantity;
                form.appendChild(inputQtd);
            });

        });


    </script>

    <style>
        .over-scroll {
            overflow: scroll;
            scroll-behavior: smooth;
            /* Para Firefox */
            scrollbar-width: none;
            /* Para Internet Explorer e Edge (versões antigas) */
            -ms-overflow-style: none;
        }
        .over-scroll::-webkit-scrollbar {
            display: none;
        }
        .product-clickable {
            box-shadow: 0 .125rem .25rem rgba(0, 0, 0, .075) !important;
            transform: translateY(0);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .product-clickable:hover {
            transform: translateY(-4px);
            box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .15) !important;
        }
    </style>
}